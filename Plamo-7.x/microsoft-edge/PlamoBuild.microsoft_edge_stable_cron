#!/bin/sh
export NO_STRIP=1
##############################################################
pkgbase='microsoft_edge'
#vers="91.0.864.33"
#rel="1"
channel="stable"
#if [ -x /usr/bin/rpm ]; then
#    vers=$(rpm -qpi microsoft-edge-dev-88.0.673.0-1.x86_64.rpm 2>/dev/null | egrep '^Version' | awk '{ print $3 }')
#else
#    vers=$release
#fi
#src="microsoft-edge-${vers}"
#url="https://packages.microsoft.com/yumrepos/edge/microsoft-edge-${channel}-${vers}-${rel}.x86_64.rpm"
verify=""
arch=`uname -m`
build=B1
OPT_CONFIG=""
DOCS=''
patchfiles=''
compress=txz
##############################################################

source /usr/share/plamobuild_functions.sh

W=$HOME/edge

if [ ! -d $W ]; then
	mkdir $W
fi

cd $W

rpmname=$(ls -art packages.microsoft.com/yumrepos/edge/microsoft-edge-$channel-*.rpm |tail -n1)

wget --timestamping -r --no-parent -A "microsoft-edge-$channel-*.rpm" https://packages.microsoft.com/yumrepos/edge/

if [ -f $rpmname ]; then
	# RPMファイルを取得したことがある
	rpmname_old=$rpmname
	rpmname=$(ls -art packages.microsoft.com/yumrepos/edge/microsoft-edge-$channel-*.rpm |tail -n1)
	if [ $rpmname = $rpmname_old ]; then
		# wget実行前の最新と実行後の最新が同じ
		echo "Edge is the latest version"
		exit 0
	fi
fi

rpm2tar $rpmname
if [ $? != 0 ]; then
	echo "failed to convert rpm to tar."
	exit 255
fi

# 存在する全てのRPMファイルを0byteにする(0byteを越えているもののみにするべきか？）
for i in *.rpm
do
		mv $i $i.bak
		touch -r $i.bak $i
		rm -f $i.bak
done

vers=`ls -l --time-style="+%Y%m%d%H%M%S" $rpmname | awk '{print $6}'`

if [ -d $P ]; then
	rm -rf $P
fi
mkdir -p $P
tar xf $(basename $rpmname .rpm).tar -C $P

rm -rf $P/etc
rm -rf $P/usr/share/gnome-control-center

cp $0 .

################################
#      install tweaks
#  strip binaries, delete locale except ja, compress man, 
#  install docs and patches, compress them and  chown root.root
################################
install_tweak

#############################
#   convert symlink to null file and 
#   add "ln -sf" command into install/doinst.sh
################################
convert_links

pkg=${pkgbase}_${channel}-${vers}-${arch}-${build}

cd $P
/sbin/makepkg ../$pkg.$compress <<EOF
y
1
EOF

/sbin/updatepkg -f ../$pkg.$compress

rm -f ../$pkg.$compress
rm -rf $W/*.tar
rm -rf $W/work
